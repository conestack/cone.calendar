var cone_calendar=function(e,t){"use strict";class a{constructor(e,t){this._calendar=e,this._events_view=t.events,delete t.events,Object.assign(this,t),this.events=this.events.bind(this)}events(e,t,a,n){let i=this._calendar,s=i.target+"/"+this._events_view,r={start:e.unix(),end:t.unix()};i.json_request(s,r,n,null)}}class n{static initialize(e){let a=t("#calendar",e);a.length&&new n(a)}constructor(e){this.elem=e,this.target=e.data("calendar_target"),this.actions=e.data("calendar_actions");let n=e.data("calendar_sources"),i=[];for(let e in n)i.push(new a(this,n[e]));let s=e.data("calendar_options");t.extend(s,{eventSources:i,eventClick:this.event_clicked.bind(this),dayClick:this.day_clicked.bind(this),eventDrop:this.event_drop.bind(this),eventResize:this.event_resize.bind(this)}),e.bind("reload",(function(){e.fullCalendar("refetchEvents")})),e.fullCalendar(s)}json_request(e,t,a,n){bdajax.request({url:e,type:"json",params:t,success:function(e){e.error?(n&&n(),bdajax.error(e.message)):a(e.data)},error:function(){n&&n(),bdajax.error("Failed to request JSON data")}})}create_context_menu(e,a,n){let i=t("body",document),s=t("<div />").attr("class","calendar-contextmenu-wrapper").css("height",i.height()+"px");i.append(s),s.on("click contextmenu",(function(e){e.preventDefault(),s.remove()}));let r=t("<ul />").attr("class","calendar-contextmenu dropdown-menu").css("left",a+"px").css("top",n+"px").css("display","block");s.append(r);for(let t in e)this.add_menu_item(s,r,e[t])}add_menu_item(e,a,n){let i=t("<li><span />"+n.title+"</li>");n.icon&&t("span",i).attr("class",n.icon),a.append(i),i.on("click",function(t){t.stopPropagation(),e.remove(),this.handle_action(n)}.bind(this))}prepare_target(e,a){return e.url||(e=bdajax.parsetarget(e)),t.extend(e.params,a),e}handle_action(e){e.target&&(e.confirm?bdajax.dialog({message:e.confirm},function(t){this.perform_action(e)}.bind(this)):this.perform_action(e))}perform_action(e){let t=e.target;if(e.action&&bdajax.action({name:e.action.name,selector:e.action.selector,mode:e.action.mode,url:t.url,params:t.params}),e.event){let a=e.event;bdajax.trigger(a.name,a.selector,t)}if(e.overlay){let a=e.overlay;bdajax.overlay({action:a.action,target:t,selector:a.selector,content_selector:a.content_selector,css:a.css})}}handle_actions(e,t,a,n,i){if(e&&e.length){e=JSON.parse(JSON.stringify(e));for(let n in e){let i=e[n];i.target=this.prepare_target(i.target||t,a)}if(1!=e.length)this.create_context_menu(e,n,i);else{let t=e[0];this.handle_action(t)}}}event_clicked(e,t,a){let n={view:a.name};this.handle_actions(e.actions,e.target,n,t.pageX,t.pageY)}day_clicked(e,t,a){let n={date:e.unix(),all_day:!e.hasTime(),view:a.name};this.handle_actions(this.actions,this.target,n,t.pageX,t.pageY)}update_event(e,t,a,n,i){let s=this.prepare_target(e.target,{id:e.id,start:e.start.unix(),end:e.end.unix(),delta:t.asSeconds()}),r=s.url+"/"+n;this.json_request(r,s.params,i,a)}event_drop(e,t,a){if(!e.editable&&!e.startEditable)return;this.update_event(e,t,a,"calendar_event_drop",(function(e){console.log(e)}))}event_resize(e,t,a){if(!e.editable&&!e.durationEditable)return;this.update_event(e,t,a,"calendar_event_resize",(function(e){console.log(e)}))}}return t((function(){bdajax.register(n.initialize,!0)})),e.Calendar=n,Object.defineProperty(e,"__esModule",{value:!0}),e}({},jQuery);
