var cone_calendar=function(e,t){"use strict";class n{constructor(e,t){this._calendar=e,this._events_view=t.events,delete t.events,Object.assign(this,t),this.events=this.events.bind(this)}events(e,t,n){let a=this._calendar,i=a.target+"/"+this._events_view,s={start:Math.floor(e.start.getTime()/1e3),end:Math.floor(e.end.getTime()/1e3),timezone:e.timeZone||"local"};a.json_request(i,s,(e=>{t(e)}),(e=>{console.error("Error fetching events:",e),n(e)}))}}class a{static initialize(e){let n=t("#calendar",e);n.length&&new a(n)}constructor(e){this.elem=e,this.target=e.data("calendar_target"),this.actions=e.data("calendar_actions");let a=e.data("calendar_sources"),i=[];for(let e in a)i.push(new n(this,a[e]));let s=e.data("calendar_options");t.extend(s,{eventSources:i,eventClick:this.event_clicked.bind(this),dateClick:this.date_clicked.bind(this),eventDrop:this.event_drop.bind(this),eventResize:this.event_resize.bind(this),plugins:[fullcalendar.bootstrap5Plugin,fullcalendar.dayGridPlugin,fullcalendar.timeGridPlugin,fullcalendar.listPlugin,fullcalendar.interactionPlugin],themeSystem:"bootstrap5",height:"auto"});const r=this.calendar=new fullcalendar.Calendar(this.elem.get(0),s);e.on("reload",(function(){r.refetchEvents()})),r.render(),t(window).on("resize",this.on_resize.bind(this)),this.on_resize()}on_resize(e){const n=t(window).width();n<=700&&(this._window_width>700||!e)?this.calendar.setOption("height","auto"):n>700&&(this._window_width<=700||!e)&&this.calendar.setOption("height",void 0),this._window_width=n}json_request(e,t,n,a){bdajax.request({url:e,type:"json",params:t,success:function(e){e.error?(a&&a(),bdajax.error(e.message)):n(e.data)},error:function(){a&&a(),bdajax.error("Failed to request JSON data")}})}create_context_menu(e,n,a){let i=t("body",document),s=t("<div />").attr("class","calendar-contextmenu-wrapper").css("height",i.height()+"px");i.append(s),s.on("click contextmenu",(function(e){e.preventDefault(),s.remove()}));let r=t("<ul />").attr("class","calendar-contextmenu dropdown-menu").css("left",n+"px").css("top",a+"px").css("display","block");s.append(r);for(let t in e)this.add_menu_item(s,r,e[t])}add_menu_item(e,n,a){let i=t("<li><span />"+a.title+"</li>");a.icon&&t("span",i).attr("class",a.icon),n.append(i),i.on("click",function(t){t.stopPropagation(),e.remove(),this.handle_action(a)}.bind(this))}prepare_target(e,n){return e.url||(e=bdajax.parsetarget(e)),t.extend(e.params,n),e}handle_action(e){e.target&&(e.confirm?bdajax.dialog({message:e.confirm},function(t){this.perform_action(e)}.bind(this)):this.perform_action(e))}perform_action(e){let t=e.target;if(e.action&&bdajax.action({name:e.action.name,selector:e.action.selector,mode:e.action.mode,url:t.url,params:t.params}),e.event){let n=e.event;bdajax.trigger(n.name,n.selector,t)}if(e.overlay){let n=e.overlay;bdajax.overlay({action:n.action,target:t,selector:n.selector,content_selector:n.content_selector,css:n.css})}}handle_actions(e,t,n,a,i){if(e&&e.length){e=JSON.parse(JSON.stringify(e));for(let a in e){let i=e[a];i.target=this.prepare_target(i.target||t,n)}if(1!=e.length)this.create_context_menu(e,a,i);else{let t=e[0];this.handle_action(t)}}}event_clicked(e){console.log(e.event),console.log(e.event.extendedProps);const t=e.jsEvent;let n={view:e.view.name};this.handle_actions(e.event.actions,e.event.target,n,t.pageX,t.pageY)}date_clicked(e){const t=e.jsEvent,n=e.date;let a={date:Math.floor(n.getTime()/1e3),all_day:n.allDay,view:e.view.name};this.handle_actions(this.actions,this.target,a,t.pageX,t.pageY)}update_event(e,t,n,a,i){let s=this.prepare_target(e.target,{id:e.id,start:Math.floor(e.start.getTime()/1e3),end:Math.floor(e.end.getTime()/1e3),delta:t.asSeconds()}),r=s.url+"/"+a;this.json_request(r,s.params,i,n)}event_drop(e,t,n){if(!e.editable&&!e.startEditable)return;this.update_event(e,t,n,"calendar_event_drop",(function(e){console.log(e)}))}event_resize(e,t,n){if(!e.editable&&!e.durationEditable)return;this.update_event(e,t,n,"calendar_event_resize",(function(e){console.log(e)}))}}return t((function(){bdajax.register(a.initialize,!0)})),e.Calendar=a,Object.defineProperty(e,"__esModule",{value:!0}),e}({},jQuery);
