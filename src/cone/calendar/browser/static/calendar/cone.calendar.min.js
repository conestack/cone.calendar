var cone_calendar=function(e,t){"use strict";class i{constructor(e,t){this._calendar=e,this._events_view=t.events,delete t.events,Object.assign(this,t),this.events=this.events.bind(this)}events(e,t,i){let n=this._calendar,s=n.target+"/"+this._events_view,a={start:Math.floor(e.start.getTime()/1e3),end:Math.floor(e.end.getTime()/1e3),timezone:e.timeZone||"local"};n.json_request(s,a,(e=>{t(e)}),(e=>{console.error("Error fetching events:",e),i(e)}))}}class n{static initialize(e){let i=t("#calendar",e);i.length&&new n(i)}constructor(e){this.elem=e,this.target=e.data("calendar_target"),this.actions=e.data("calendar_actions");let n=e.data("calendar_sources"),s=[];for(let e in n)s.push(new i(this,n[e]));let a=e.data("calendar_options");t.extend(a,{eventSources:s,eventClick:this.event_clicked.bind(this),dateClick:this.date_clicked.bind(this),eventDrop:this.event_drop.bind(this),eventResize:this.event_resize.bind(this),moreLinkDidMount(i){i.el.addEventListener("click",(()=>{setTimeout((()=>{const i=t(".fc-popover");if(i){const t=e.outerWidth(),n=i.outerWidth();parseInt(i.css("left"))+n>t&&i.css("transform","translateX(-100%)")}}),0)}))},timeZone:"UTC",plugins:[fullcalendar.bootstrap5Plugin,fullcalendar.dayGridPlugin,fullcalendar.timeGridPlugin,fullcalendar.listPlugin,fullcalendar.interactionPlugin],themeSystem:"bootstrap5",height:"auto"}),this.close_on_outside_click=this.close_on_outside_click.bind(this);const o=this.calendar=new fullcalendar.Calendar(this.elem.get(0),a);this.refetch_events=this.refetch_events.bind(this),this.elem.on("reload",this.refetch_events),o.render(),this.on_resize=this.on_resize.bind(this),t(window).on("resize",this.on_resize),cone.global_events.on("on_sidebar_left_resize",this.on_resize),cone.global_events.on("on_sidebar_right_resize",this.on_resize),this.on_resize(),window.ts.ajax.attach(this,e)}refetch_events(){this.calendar.refetchEvents()}on_resize(e){const i=t(window).width();i<=700&&(this._window_width>700||!e)?this.calendar.setOption("height","auto"):i>700&&(this._window_width<=700||!e)&&this.calendar.setOption("height",void 0),this.calendar.updateSize(),this.elem.outerWidth()<=700?this.calendar.setOption("dayMaxEventRows",0):this.calendar.setOption("dayMaxEventRows",3),this._window_width=i}json_request(e,t,i,n){bdajax.request({url:e,type:"json",params:t,success:function(e){e.error?(n&&n(),bdajax.error(e.message)):i(e.data)},error:function(){n&&n(),bdajax.error("Failed to request JSON data")}})}close_on_outside_click(){const e=t=>{const i=t.composedPath(),n=i.some((e=>e.classList&&e.classList.contains("fc-event")));i.includes(this.menu)||n||(this.menu.remove(),document.removeEventListener("click",e))};setTimeout((()=>{document.addEventListener("click",e)}))}create_context_menu(e,i,n){const s=t("body",document);this.wrapper&&this.wrapper.remove();const a=this.wrapper=t("<div />").attr("class","calendar-contextmenu-wrapper").css("height",s.height()+"px");s.append(a),a.on("click contextmenu",(function(e){e.preventDefault(),a.remove()}));const o=t("<ul>").addClass("calendar-contextmenu dropdown-menu list-group list-group-flush p-0 rounded shadow").css({position:"absolute",left:"-9999px",top:"-9999px",visibility:"hidden",display:"block"});s.append(o);for(let t in e)this.add_menu_item(a,o,e[t]);const r=o.outerWidth();let l;i+r>t(window).width()?(l=i-r,l<0&&(l=0)):l=i,o.css({left:l+"px",top:n+"px",visibility:"visible"}),this.menu=o,a.append(o),this.close_on_outside_click()}add_menu_item(e,i,n){const s=t("<li>").addClass("list-group-item list-group-item-action");n.icon&&t(`<i class="${n.icon} me-2"></i>`).appendTo(s),t(`<span>${n.title}</span>`).appendTo(s),i.append(s),s.on("click",function(t){t.stopPropagation(),e.remove(),this.handle_action(n)}.bind(this))}prepare_target(e,i){return e.url||(e=bdajax.parsetarget(e)),t.extend(e.params,i),e}handle_action(e){e.target&&(e.confirm?bdajax.dialog({message:e.confirm},function(t){this.perform_action(e)}.bind(this)):this.perform_action(e))}perform_action(e){let t=e.target;if(e.action&&bdajax.action({name:e.action.name,selector:e.action.selector,mode:e.action.mode,url:t.url,params:t.params}),e.event){let i=e.event;bdajax.trigger(i.name,i.selector,t)}if(e.overlay){let i=e.overlay;bdajax.overlay({action:i.action,target:t,selector:i.selector,content_selector:i.content_selector,css:i.css})}}handle_actions(e,t,i,n,s){if(e&&e.length){e=JSON.parse(JSON.stringify(e));for(let n in e){let s=e[n];s.target=this.prepare_target(s.target||t,i)}if(1!=e.length)this.create_context_menu(e,n,s);else{let t=e[0];this.handle_action(t)}}}event_clicked(e){const t=e.jsEvent;let i={view:e.view.name};this.handle_actions(e.event.extendedProps.actions,e.event.extendedProps.target,i,t.pageX,t.pageY)}date_clicked(e){const t=e.jsEvent,i=e.date;let n={date:Math.floor(i.getTime()/1e3),all_day:i.allDay,view:e.view.type};this.handle_actions(this.actions,this.target,n,t.pageX,t.pageY)}update_event(e,t,i,n,s){let a=this.prepare_target(e.target,{id:e.id,start:Math.floor(e.start.getTime()/1e3),end:Math.floor(e.end.getTime()/1e3),delta:t.asSeconds()}),o=a.url+"/"+n;this.json_request(o,a.params,s,i)}event_drop(e,t,i){if(!e.editable&&!e.startEditable)return;this.update_event(e,t,i,"calendar_event_drop",(function(e){console.log(e)}))}event_resize(e,t,i){if(!e.editable&&!e.durationEditable)return;this.update_event(e,t,i,"calendar_event_resize",(function(e){console.log(e)}))}destroy(){this.elem.off("reload",this.refetch_events),this.calendar.destroy(),this.calendar=null,this.wrapper&&this.wrapper.remove(),t(window).off("resize",this.on_resize),cone.global_events.off("on_sidebar_left_resize",this.on_resize),cone.global_events.off("on_sidebar_right_resize",this.on_resize)}}return t((function(){bdajax.register(n.initialize,!0)})),e.Calendar=n,Object.defineProperty(e,"__esModule",{value:!0}),e}({},jQuery);
